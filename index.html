<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C61 Land Programme</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global Styles & Variables */
        :root {
            --bg-dark: #0A0A1F; /* Deep space background */
            --bg-medium: #1A1A3B; /* Slightly lighter for sections */
            --bg-light: #2A2A5C; /* Even lighter for cards/elements */
            --primary-accent: #E94560; /* Vibrant electric pink */
            --secondary-accent: #00BCD4; /* Electric cyan */
            --tertiary-accent: #6C5CE7; /* Deep purple */
            --text-light: #E0E0E0; /* Bright text on dark background */
            --text-dark: #CCCCCC; /* Subdued text */
            --border-color: rgba(255, 255, 255, 0.1); /* Subtle white border for depth */
            --glow-color-primary: rgba(233, 69, 96, 0.6); /* Pink glow */
            --glow-color-secondary: rgba(0, 188, 212, 0.5); /* Cyan glow */
            --shadow-strong: rgba(0, 0, 0, 0.8);
            --transition-speed: 0.4s;
            --font-family-title: 'Orbitron', sans-serif;
            --font-family-body: 'Inter', sans-serif;
            --success-color: #4CAF50;
            --error-color: #F44336;
        }

        /* Basic Reset & Body Styling */
        body {
            font-family: var(--font-family-body);
            margin: 0;
            padding: 0;
            background: linear-gradient(145deg, var(--bg-dark) 0%, #050510 100%);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content from top */
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            width: 95%;
            padding: 40px;
            background-color: var(--bg-medium);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-strong);
            margin: 30px 0;
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            overflow: hidden; /* For inner glow effects */
        }
        .container::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent), var(--tertiary-accent));
            background-size: 400% 400%;
            border-radius: 22px;
            z-index: -1;
            filter: blur(15px);
            opacity: 0.15;
            animation: glowing-border 10s infinite alternate;
        }
        @keyframes glowing-border {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Headings */
        h2 {
            font-family: var(--font-family-title);
            text-align: center;
            color: var(--primary-accent);
            margin-bottom: 25px;
            font-weight: 800;
            font-size: 3.5em; /* Larger for impact */
            text-shadow: 0 0 20px var(--glow-color-primary), 0 0 30px var(--glow-color-secondary);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        h3 {
            font-family: var(--font-family-title);
            color: var(--secondary-accent);
            margin-top: 35px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
            letter-spacing: 0.03em;
        }
        .initial-subtitle {
            text-align: center;
            font-size: 1.2em;
            color: var(--text-dark);
            margin-top: -15px;
            margin-bottom: 40px;
            font-weight: 400;
            line-height: 1.5;
        }
        .initial-subtitle strong {
            color: var(--primary-accent);
            font-weight: 700;
        }

        /* Section Display */
        .section {
            display: none;
            animation: slideIn 0.6s ease-out forwards;
            padding: 20px 0;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 1.1em;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-sizing: border-box;
            width: 100%;
            max-width: 500px; /* Slightly wider forms */
            font-size: 1.1em;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
            background-color: var(--bg-dark);
            color: var(--text-light);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--secondary-accent);
            box-shadow: 0 0 20px var(--glow-color-secondary), inset 0 0 8px rgba(0, 188, 212, 0.3);
            background-color: #0F1A2A;
        }
        #kingdomInputsContainer {
            border: 1px dashed rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            background-color: rgba(0,0,0,0.15);
            margin-top: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }
        #kingdomInputsContainer input {
            margin-bottom: 15px;
        }

        /* Buttons */
        .button-group {
            text-align: center;
            margin-top: 40px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .button-group button,
        .add-kingdom-btn,
        .nav-btn,
        .action-button,
        .modal-button {
            padding: 15px 35px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, var(--primary-accent), var(--tertiary-accent));
            color: var(--text-light);
            cursor: pointer;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background var(--transition-speed) ease;
            font-weight: 700;
            box-shadow: 0 8px 20px var(--shadow-strong);
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }
        .button-group button::before,
        .add-kingdom-btn::before,
        .nav-btn::before,
        .action-button::before,
        .modal-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.4s ease-out;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: 0;
        }
        .button-group button:hover::before,
        .add-kingdom-btn:hover::before,
        .nav-btn:hover::before,
        .action-button:hover::before,
        .modal-button:hover::before {
            width: 0%;
            height: 0%;
            opacity: 1;
        }
        .button-group button:hover,
        .add-kingdom-btn:hover,
        .nav-btn:hover,
        .action-button:hover,
        .modal-button:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 25px var(--shadow-strong), 0 0 25px var(--glow-color-primary);
            background: linear-gradient(45deg, var(--tertiary-accent), var(--primary-accent));
        }

        .add-kingdom-btn {
            background: linear-gradient(45deg, var(--success-color), #2E7D32);
            padding: 12px 25px;
            font-size: 1em;
            margin-top: 20px;
        }
        .add-kingdom-btn:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.6), 0 0 15px rgba(76, 175, 80, 0.5);
            background: linear-gradient(45deg, #2E7D32, var(--success-color));
        }
        .action-button.delete-btn {
            background: linear-gradient(45deg, var(--error-color), #B71C1C);
            padding: 10px 20px;
            font-size: 0.9em;
            margin: 5px;
        }
        .action-button.delete-btn:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.5), 0 0 10px rgba(244, 67, 54, 0.5);
            background: linear-gradient(45deg, #B71C1C, var(--error-color));
        }

        /* Navigation Bar */
        .nav-bar {
            text-align: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .nav-bar button {
            background: var(--bg-light);
            color: var(--secondary-accent);
            border: 1px solid rgba(0, 188, 212, 0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            padding: 12px 25px;
            font-size: 1em;
        }
        .nav-bar button.active {
            background: linear-gradient(90deg, var(--secondary-accent), var(--tertiary-accent));
            color: var(--text-light);
            border: none;
            box-shadow: 0 6px 15px var(--glow-color-secondary), 0 0 10px var(--glow-color-secondary);
            transform: translateY(-3px);
        }
        .nav-bar button.active:hover {
             transform: translateY(-3px); /* Prevent extra lift on active hover */
        }


        /* Messages (Success/Error/Loading) */
        .message {
            margin-top: 25px;
            text-align: center;
            font-weight: 600;
            padding: 18px;
            border-radius: 12px;
            transition: all var(--transition-speed) ease-in-out;
            opacity: 0;
            visibility: hidden;
            max-height: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        .message.show {
            opacity: 1;
            visibility: visible;
            max-height: 100px; /* Adjust as needed */
            margin-bottom: 25px;
        }
        .error-message {
            color: var(--error-color);
            background-color: rgba(244, 67, 54, 0.15);
            border: 1px solid var(--error-color);
        }
        .success-message {
            color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.15);
            border: 1px solid var(--success-color);
        }
        .loading-message {
            color: var(--secondary-accent);
            background-color: rgba(0, 188, 212, 0.1);
            border: 1px solid var(--secondary-accent);
        }
        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary-accent);
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .loading-message .spinner {
            display: block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tables */
        .table-container {
            max-height: 550px; /* Taller tables for more data */
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
            margin-top: 30px;
            background-color: rgba(0,0,0,0.2); /* Semi-transparent for background visibility */
            padding: 1px; /* To prevent border-radius clipping */
        }
        table {
            width: 100%;
            border-collapse: separate; /* For rounded corners on cells */
            border-spacing: 0;
            font-size: 0.98em;
            background-color: var(--bg-medium);
            border-radius: 15px;
            overflow: hidden; /* Hide anything outside rounded borders */
        }
        table th, table td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            border-right: 1px solid rgba(255, 255, 255, 0.08); /* Vertical borders */
            padding: 16px 20px;
            text-align: left;
            word-break: break-word;
        }
        table th:last-child, table td:last-child {
            border-right: none; /* No border on last column */
        }
        table tr:last-child td {
            border-bottom: none; /* No border on last row */
        }
        table th {
            background-color: rgba(0, 188, 212, 0.2); /* Cyan header bg */
            font-weight: 700;
            color: var(--secondary-accent);
            position: sticky;
            top: 0;
            z-index: 2;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        table th:hover {
            background-color: rgba(0, 188, 212, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 188, 212, 0.2);
        }
        table th.asc::after { content: ' \25B2'; color: var(--primary-accent); }
        table th.desc::after { content: ' \25BC'; color: var(--primary-accent); }

        table tr:nth-child(even) {
            background-color: rgba(0,0,0,0.1); /* Subtle stripe */
        }
        table tbody tr:hover {
            background-color: rgba(0, 188, 212, 0.1);
            transition: background-color 0.2s ease;
        }
        .total-row {
            font-weight: 700;
            background-color: rgba(233, 69, 96, 0.15); /* Pink accent for total */
            color: var(--primary-accent);
            font-size: 1.1em;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }
        p strong {
            color: var(--primary-accent);
        }
        #userOverallTotal, #adminOverallTotal, #topContributorsOverallTotal {
            color: var(--secondary-accent);
            font-size: 1.3em;
            text-shadow: 0 0 8px rgba(0, 188, 212, 0.6);
        }

        /* Search/Filter Inputs */
        .filter-group {
            margin-top: 25px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-group label {
            margin-bottom: 0;
            color: var(--text-light);
            font-weight: 500;
            font-size: 1.05em;
            white-space: nowrap;
        }
        .filter-group input {
            padding: 12px 18px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            max-width: 350px;
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-size: 1em;
        }
        .filter-group input:focus {
            border-color: var(--secondary-accent);
            box-shadow: 0 0 10px var(--glow-color-secondary);
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.85); /* Darker overlay */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--bg-medium);
            margin: auto;
            padding: 40px;
            border: 2px solid var(--primary-accent);
            border-radius: 20px;
            box-shadow: 0 8px 30px var(--glow-color-primary);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            animation: scaleIn 0.4s ease-out;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content h3 {
            color: var(--primary-accent);
            font-family: var(--font-family-title);
            margin-top: 0;
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--glow-color-primary);
        }

        .modal-content p {
            margin: 25px 0;
            color: var(--text-light);
            font-size: 1.15em;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                width: 98%;
                margin: 15px 0;
                border-radius: 15px;
            }
            .container::before {
                border-radius: 17px;
            }
            h2 {
                font-size: 2.5em;
                margin-bottom: 20px;
            }
            h3 {
                font-size: 1.6em;
                margin-top: 25px;
                margin-bottom: 15px;
            }
            .initial-subtitle {
                font-size: 1em;
                margin-bottom: 30px;
            }
            .form-group input, .form-group select {
                max-width: none;
                padding: 14px 16px;
                font-size: 1em;
                border-radius: 10px;
            }
            .button-group button, .add-kingdom-btn, .nav-btn, .action-button, .modal-button {
                padding: 12px 25px;
                font-size: 1em;
                flex-grow: 1;
                margin: 5px;
                border-radius: 10px;
            }
            .button-group {
                gap: 10px;
            }
            .nav-bar {
                flex-direction: column;
                gap: 10px;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 10px;
            }
            table {
                min-width: 700px; /* Ensure table doesn't collapse too much */
                border-radius: 10px;
            }
            table th, table td {
                padding: 12px 15px;
                font-size: 0.95em;
            }
            .message {
                padding: 15px;
                font-size: 0.95em;
                border-radius: 10px;
            }
            .filter-group {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            .filter-group input {
                max-width: none;
            }
            .modal-content {
                width: 95%;
                padding: 30px;
                border-radius: 15px;
            }
            .modal-content h3 {
                font-size: 1.6em;
            }
            .modal-content p {
                font-size: 1.05em;
            }
            .modal-buttons {
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
            }
            .container::before {
                border-radius: 12px;
            }
            h2 {
                font-size: 2em;
                margin-bottom: 15px;
            }
            h3 {
                font-size: 1.4em;
                margin-top: 20px;
                margin-bottom: 10px;
            }
            .initial-subtitle {
                font-size: 0.9em;
                margin-bottom: 20px;
            }
            .button-group button, .add-kingdom-btn, .nav-btn, .action-button, .modal-button {
                padding: 10px 20px;
                font-size: 0.9em;
                flex-grow: 1;
                margin: 4px;
                border-radius: 8px;
            }
            .nav-bar button {
                font-size: 0.85em;
            }
            table th, table td {
                padding: 10px 12px;
                font-size: 0.9em;
            }
            .action-button.delete-btn {
                padding: 8px 15px;
                font-size: 0.8em;
            }
            .modal-content {
                padding: 20px;
                border-radius: 12px;
            }
            .modal-content h3 {
                font-size: 1.4em;
            }
            .modal-content p {
                font-size: 0.95em;
                margin: 15px 0;
            }
            .modal-buttons {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Initial Landing Page -->
        <div id="initialPage" class="section">
            <h2>C61 Land Programme</h2>
            <p class="initial-subtitle">developed by <strong>RCBK.Dev</strong> - Your gateway to efficient League of Kingdoms land contribution tracking.</p>
            <div class="button-group">
                <button onclick="showSection('loginSection')">Login</button>
                <button onclick="showSection('registerSection')">Register</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="section">
            <h2>Login to Your Account</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username:</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="button-group">
                    <button type="submit">Login</button>
                    <button type="button" onclick="showSection('initialPage')">Back</button>
                </div>
                <p id="loginMessage" class="message"><span class="spinner"></span></p>
            </form>
        </div>

        <!-- Register Section -->
        <div id="registerSection" class="section">
            <h2>Register New User</h2>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="regUsername">Username:</label>
                    <input type="text" id="regUsername" required autocomplete="new-username">
                </div>
                <div class="form-group">
                    <label for="regWalletAddress">Wallet Address:</label>
                    <input type="text" id="regWalletAddress" required autocomplete="off" placeholder="e.g., 0xabcdef1234567890abcdef1234567890abcdef">
                </div>
                <div class="form-group">
                    <label>Kingdom IDs:</label>
                    <div id="kingdomInputsContainer">
                        <input type="text" class="kingdom-id-input" placeholder="Kingdom ID 1 (e.g., 6716055e58f73c2ae87c9d82)" required>
                    </div>
                    <button type="button" class="add-kingdom-btn" onclick="addKingdomInput()">+ Add Another Kingdom ID</button>
                </div>
                <div class="button-group">
                    <button type="submit">Register</button>
                    <button type="button" onclick="showSection('initialPage')">Back</button>
                </div>
                <p id="registerMessage" class="message"><span class="spinner"></span></p>
            </form>
        </div>

        <!-- User Dashboard Section -->
        <div id="userDashboardSection" class="section">
            <h2 id="welcomeUser">Welcome, User!</h2>
            <div class="nav-bar">
                <button class="nav-btn active" onclick="showUserContributions()">My Contributions</button>
                <button class="nav-btn" onclick="showManageKingdoms()">Manage Kingdoms</button>
                <button class="nav-btn" onclick="showUserTopContributors()">Top Contributors</button> <!-- New button for users -->
                <button class="nav-btn" onclick="showAdminDashboard()">Admin Dashboard</button>
                <button class="nav-btn" onclick="logout()">Logout</button>
            </div>

            <!-- User Contributions Sub-section -->
            <div id="userContributionsSubSection">
                <h3>My Land Contributions</h3>
                <div class="form-group">
                    <label for="contributionPeriod">Select Period:</label>
                    <select id="contributionPeriod" onchange="getUserContributions()">
                        <option value="currentWeek">Current Week</option>
                        <option value="lastWeek">Last Week</option>
                        <option value="currentMonth">Current Month</option>
                        <option value="lastMonth">Last Month</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="userContributionTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('userContributionTable', 0)">From</th>
                                <th onclick="sortTable('userContributionTable', 1)">To</th>
                                <th onclick="sortTable('userContributionTable', 2)">Kingdom ID</th>
                                <th onclick="sortTable('userContributionTable', 3)">Name</th>
                                <th onclick="sortTable('userContributionTable', 4)">Continent</th>
                                <th onclick="sortTable('userContributionTable', 5)">Total Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan='6'>Select a period to see contributions.</td></tr>
                        </tbody>
                    </table>
                </div>
                <p style="text-align: right; font-weight: bold; margin-top: 15px;">Total Contribution for selected kingdoms: <span id="userOverallTotal">0</span></p>
                <div class="button-group">
                     <button type="button" onclick="exportUserContributionsToCSV()">Export to CSV</button>
                </div>
                 <p id="userContributionMessage" class="message"><span class="spinner"></span></p>
            </div>

            <!-- Manage Kingdoms Sub-section -->
            <div id="manageKingdomsSubSection" style="display: none;">
                <h3>Manage Your Kingdom IDs</h3>
                <div class="form-group">
                    <label for="newKingdomId">Add New Kingdom ID:</label>
                    <input type="text" id="newKingdomId" placeholder="Enter new Kingdom ID (e.g., 6716055e58f73c2ae87c9d82)">
                    <button type="button" class="add-kingdom-btn" onclick="addNewKingdom()">Add Kingdom</button>
                </div>
                <div class="table-container">
                    <table id="userKingdomsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('userKingdomsTable', 0)">Kingdom ID</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan='2'>Loading your kingdom IDs...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p id="manageKingdomsMessage" class="message"><span class="spinner"></span></p>
                <div class="button-group">
                    <button type="button" onclick="showUserContributions()">Back to Contributions</button>
                </div>
            </div>

            <!-- Top Contributors Sub-section for Users -->
            <div id="userTopContributorsSubSection" style="display: none;">
                <h3>Top Contributors (Overall)</h3>
                <div class="form-group">
                    <label for="userTopContributorPeriod">Select Period:</label>
                    <select id="userTopContributorPeriod" onchange="getUserTopContributorsData()">
                        <option value="currentWeek">Current Week</option>
                        <option value="lastWeek">Last Week</option>
                        <option value="currentMonth">Current Month</option>
                        <option value="lastMonth">Last Month</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="userTopContributorsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('userTopContributorsTable', 0)">Rank</th>
                                <th onclick="sortTable('userTopContributorsTable', 1)">Username</th>
                                <th onclick="sortTable('userTopContributorsTable', 2)">Total Contribution</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan='3'>Loading top contributors...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p style="text-align: right; font-weight: bold; margin-top: 15px;">Period Total: <span id="userTopContributorsOverallTotal">0</span></p>
                <p id="userTopContributorsMessage" class="message"><span class="spinner"></span></p>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="adminDashboardSection" class="section">
            <h2>Admin Dashboard</h2>
            <div class="nav-bar">
                <button class="nav-btn" onclick="showUserContributions()">My Contributions</button>
                <button class="nav-btn active" onclick="showAdminDashboard()">Admin Dashboard</button>
                <button class="nav-btn" onclick="logout()">Logout</button>
            </div>

            <h3>All Registered Users</h3>
            <div class="filter-group">
                <label for="userSearch">Search Users:</label>
                <input type="text" id="userSearch" onkeyup="filterTable('adminUsersTable', 'userSearch')" placeholder="Search by username">
            </div>
            <div class="table-container">
                <table id="adminUsersTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('adminUsersTable', 0)">Username</th>
                            <th onclick="sortTable('adminUsersTable', 1)">Wallet Address</th>
                            <th onclick="sortTable('adminUsersTable', 2)">Kingdom IDs</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan='3'>Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <h3 style="margin-top: 30px;">All User Contributions</h3>
            <div class="filter-group">
                <label for="adminContributionPeriod">Select Period:</label>
                <select id="adminContributionPeriod" onchange="getAdminContributions()">
                    <option value="currentWeek">Current Week</option>
                    <option value="lastWeek">Last Week</option>
                    <option value="currentMonth">Current Month</option>
                    <option value="lastMonth">Last Month</option>
                </select>
                <label for="contributionSearch">Filter:</label>
                <input type="text" id="contributionSearch" onkeyup="filterTable('adminContributionTable', 'contributionSearch')" placeholder="Search Username or Kingdom ID">
            </div>
            <div class="table-container">
                <table id="adminContributionTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('adminContributionTable', 0)">Username</th>
                            <th onclick="sortTable('adminContributionTable', 1)">Kingdom ID</th>
                            <th onclick="sortTable('adminContributionTable', 2)">Name</th>
                            <th onclick="sortTable('adminContributionTable', 3)">Continent</th>
                            <th onclick="sortTable('adminContributionTable', 4)">Total Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan='5'>Select a period to see contributions.</td></tr>
                    </tbody>
                </table>
            </div>
            <p style="text-align: right; font-weight: bold; margin-top: 15px;">Overall Total Contributions (All Users): <span id="adminOverallTotal">0</span></p>
             <div class="button-group">
                 <button type="button" onclick="exportAdminContributionsToCSV()">Export to CSV</button>
            </div>
            <p id="adminContributionMessage" class="message"><span class="spinner"></span></p>

            <h3 style="margin-top: 30px;">Top Contributors</h3>
            <div class="form-group">
                <label for="topContributorPeriod">Select Period:</label>
                <select id="topContributorPeriod" onchange="getTopContributorsData()">
                    <option value="currentWeek">Current Week</option>
                    <option value="lastWeek">Last Week</option>
                    <option value="currentMonth">Current Month</option>
                    <option value="lastMonth">Last Month</option>
                </select>
            </div>
            <div class="table-container">
                <table id="topContributorsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('topContributorsTable', 0)">Rank</th>
                            <th onclick="sortTable('topContributorsTable', 1)">Username</th>
                            <th onclick="sortTable('topContributorsTable', 2)">Total Contribution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan='3'>Loading top contributors...</td></tr>
                    </tbody>
                </table>
            </div>
            <p style="text-align: right; font-weight: bold; margin-top: 15px;">Period Total: <span id="topContributorsOverallTotal">0</span></p>
            <p id="topContributorsMessage" class="message"><span class="spinner"></span></p>
        </div>
    </div>

    <!-- Custom Modal for Confirmations/Alerts -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmation</h3>
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-button">Confirm</button>
                <button id="modalCancelBtn" class="modal-button cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null; // Stores logged-in user data
        const ADMIN_USERNAMES = ["HelenA", "RCBK.dev", "Mlands1"]; // Updated to an array of admin usernames

        // Helper to set message with type (success/error/loading) and optional timeout
        let messageTimeoutId;
        function setMessage(elementId, message, type, duration = 5000) { // type: 'success', 'error', 'loading'
            clearTimeout(messageTimeoutId); // Clear any existing timeout
            const element = document.getElementById(elementId);
            const spinner = element.querySelector('.spinner');

            element.textContent = message;
            if (spinner) { // Re-append spinner if it exists
                element.appendChild(spinner);
            }
            element.className = `message ${type}-message show`; // Add 'show' class

            if (type === 'loading') {
                if (spinner) spinner.style.display = 'block';
            } else {
                if (spinner) spinner.style.display = 'none';
                messageTimeoutId = setTimeout(() => {
                    element.classList.remove('show');
                    // Optionally clear text after animation
                    setTimeout(() => element.textContent = '', 300);
                }, duration);
            }
        }

        // Helper to show/hide loading indicator
        function showLoading(messageElementId, loadingText = "Loading...") {
            setMessage(messageElementId, loadingText, 'loading');
        }

        function hideLoading(messageElementId) {
            clearTimeout(messageTimeoutId); // Stop any pending timeout for loading message
            const element = document.getElementById(messageElementId);
            element.classList.remove('show');
            const spinner = element.querySelector('.spinner');
            if (spinner) spinner.style.display = 'none';
            setTimeout(() => element.textContent = '', 300);
        }

        // Custom Modal Function (replaces alert/confirm)
        function showCustomModal(title, message, isConfirm = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const modalConfirmBtn = document.getElementById('modalConfirmBtn');
                const modalCancelBtn = document.getElementById('modalCancelBtn');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                if (isConfirm) {
                    modalConfirmBtn.style.display = 'inline-block';
                    modalCancelBtn.style.display = 'inline-block';
                } else {
                    modalConfirmBtn.style.display = 'none';
                    modalCancelBtn.style.display = 'none'; // For simple alerts, only close
                }

                modal.style.display = 'flex'; // Show modal

                const handleConfirm = () => {
                    modal.style.display = 'none';
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.style.display = 'none';
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);

                // Allow clicking outside to close for alerts, but not confirms
                if (!isConfirm) {
                    modal.addEventListener('click', function dismissModal(event) {
                        if (event.target === modal) {
                            modal.style.display = 'none';
                            modal.removeEventListener('click', dismissModal);
                            resolve(false); // Resolve false if alert is dismissed by clicking outside
                        }
                    });
                }
            });
        }


        document.addEventListener('DOMContentLoaded', (event) => {
            showSection('initialPage');
        });

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.style.display = 'none';
                section.style.animation = 'none'; // Reset animation
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.style.display = 'block';
                activeSection.style.animation = 'slideIn 0.6s ease-out forwards'; // Apply animation
            }


            // Clear all messages when changing sections
            document.querySelectorAll('.message').forEach(msgElement => {
                msgElement.classList.remove('show');
                msgElement.textContent = '';
                clearTimeout(messageTimeoutId); // Clear any pending timeout
                const spinner = msgElement.querySelector('.spinner');
                if (spinner) spinner.style.display = 'none';
            });

            // Handle nav button active state
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));

            if (sectionId === 'userDashboardSection') {
                // Default to 'My Contributions' when entering user dashboard
                document.querySelector('#userDashboardSection .nav-btn:nth-child(1)').classList.add('active');
                document.getElementById('userContributionsSubSection').style.display = 'block';
                document.getElementById('manageKingdomsSubSection').style.display = 'none'; // Hide manage kingdoms
                document.getElementById('userTopContributorsSubSection').style.display = 'none'; // Hide user top contributors
                getUserContributions(); // Load user contributions on dashboard entry
            } else if (sectionId === 'adminDashboardSection') {
                 document.querySelector('#adminDashboardSection .nav-btn:nth-child(2)').classList.add('active');
                 getAdminUsers(); // Load admin users
                 getAdminContributions(); // Load admin contributions
                 getTopContributorsData(); // Load top contributors
            }
        }

        function showUserContributions() {
            // Hide other user sub-sections
            document.getElementById('manageKingdomsSubSection').style.display = 'none';
            document.getElementById('userTopContributorsSubSection').style.display = 'none';
            // Show 'My Contributions'
            document.getElementById('userContributionsSubSection').style.display = 'block';
            // Update active nav button
            document.querySelectorAll('#userDashboardSection .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('#userDashboardSection .nav-btn:nth-child(1)').classList.add('active');
            getUserContributions(); // Load contributions
        }

        // Function to show Manage Kingdoms section
        function showManageKingdoms() {
            // Hide other user sub-sections
            document.getElementById('userContributionsSubSection').style.display = 'none';
            document.getElementById('userTopContributorsSubSection').style.display = 'none';
            // Show 'Manage Kingdoms'
            document.getElementById('manageKingdomsSubSection').style.display = 'block';
            // Update active nav button
            document.querySelectorAll('#userDashboardSection .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('#userDashboardSection .nav-btn:nth-child(2)').classList.add('active');
            loadUserKingdoms(); // Load kingdoms when showing this section
        }

        // Function to show User Top Contributors section
        function showUserTopContributors() {
            // Hide other user sub-sections
            document.getElementById('userContributionsSubSection').style.display = 'none';
            document.getElementById('manageKingdomsSubSection').style.display = 'none';
            // Show 'Top Contributors'
            document.getElementById('userTopContributorsSubSection').style.display = 'block';
            // Update active nav button
            document.querySelectorAll('#userDashboardSection .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('#userDashboardSection .nav-btn:nth-child(3)').classList.add('active'); // Third button is Top Contributors
            getUserTopContributorsData(); // Load data for user top contributors
        }

        async function showAdminDashboard() {
            // Check if current user's username is in the ADMIN_USERNAMES array
            if (currentUser && ADMIN_USERNAMES.map(name => name.toLowerCase()).includes(currentUser.username.toLowerCase())) {
                showSection('adminDashboardSection');
                // The showSection will call getAdminUsers(), getAdminContributions(), getTopContributorsData()
            } else {
                await showCustomModal("Access Denied", "You do not have administrative privileges to access this section.", false);
                showSection('initialPage'); // Or stay on current page
            }
        }

        async function logout() {
            currentUser = null;
            await showCustomModal("Logged Out", "Logged out successfully!", false);
            showSection('initialPage');
        }

        function addKingdomInput() {
            const container = document.getElementById('kingdomInputsContainer');
            const inputCount = container.querySelectorAll('.kingdom-id-input').length + 1;
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'kingdom-id-input';
            newInput.placeholder = `Kingdom ID ${inputCount} (e.g., 6716055e58f73c2ae87c9d82)`;
            newInput.required = true;
            container.appendChild(newInput);
        }

        function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const walletAddress = document.getElementById('regWalletAddress').value.trim();
            const kingdomInputs = document.querySelectorAll('.kingdom-id-input');
            const kingdomIds = Array.from(kingdomInputs)
                                   .map(input => input.value.trim())
                                   .filter(id => id !== '');

            if (!username || !walletAddress || kingdomIds.length === 0) {
                setMessage('registerMessage', "All fields are required and at least one Kingdom ID must be provided.", 'error');
                return;
            }

            showLoading('registerMessage', 'Registering user...'); // Show loading indicator
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('registerMessage'); // Hide loading
                    if (response.success) {
                        setMessage('registerMessage', "Registration successful! You can now log in.", 'success');
                        document.getElementById('regUsername').value = '';
                        document.getElementById('regWalletAddress').value = '';
                        document.getElementById('kingdomInputsContainer').innerHTML = '<input type="text" class="kingdom-id-input" placeholder="Kingdom ID 1 (e.g., 6716055e58f73c2ae87c9d82)" required>';
                    } else {
                        setMessage('registerMessage', response.message || "Registration failed. Please try again.", 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading('registerMessage'); // Hide loading
                    setMessage('registerMessage', "Error during registration: " + error.message, 'error');
                })
                .registerUser(username, walletAddress, kingdomIds);
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();

            if (!username) {
                setMessage('loginMessage', "Username is required.", 'error');
                return;
            }

            // Check for admin login
            if (ADMIN_USERNAMES.map(name => name.toLowerCase()).includes(username.toLowerCase())) {
                currentUser = { username: username, kingdomIds: [] }; // Admin has no specific kingdom IDs
                document.getElementById('welcomeUser').textContent = `Welcome, ${username}!`; // Use actual username
                showAdminDashboard(); // Direct admin to admin dashboard
                setMessage('loginMessage', '', 'success'); // Clear message
                document.getElementById('loginUsername').value = ''; // Clear input
                return;
            }

            showLoading('loginMessage', 'Logging in...'); // Show loading indicator
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('loginMessage'); // Hide loading
                    if (response.success) {
                        currentUser = response.user;
                        document.getElementById('welcomeUser').textContent = `Welcome, ${currentUser.username}!`;
                        // *** CRITICAL FIX HERE: Use showSection to ensure the main dashboard is visible ***
                        showSection('userDashboardSection'); // This will also trigger getUserContributions()
                        setMessage('loginMessage', '', 'success'); // Clear message
                        document.getElementById('loginUsername').value = ''; // Clear input
                    } else {
                        setMessage('loginMessage', response.message || "Login failed. Please check your username.", 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading('loginMessage'); // Hide loading
                    setMessage('loginMessage', "Error during login: " + error.message, 'error');
                })
                .loginUser(username);
        }

        function getUserContributions() {
            if (!currentUser || ADMIN_USERNAMES.map(name => name.toLowerCase()).includes(currentUser.username.toLowerCase())) {
                document.getElementById('userContributionTable').querySelector('tbody').innerHTML = '<tr><td colspan="6">Please log in as a regular user to see contributions.</td></tr>';
                document.getElementById('userOverallTotal').textContent = '0';
                return;
            }

            const period = document.getElementById('contributionPeriod').value;
            const tableBody = document.querySelector("#userContributionTable tbody");
            tableBody.innerHTML = "<tr><td colspan='6'>Fetching your kingdom contributions...</td></tr>"; // Initial message before spinner
            document.getElementById('userOverallTotal').textContent = 'Calculating...';
            showLoading('userContributionMessage', 'Fetching your contributions...');

            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('userContributionMessage');
                    displayUserContributions(response.data);
                })
                .withFailureHandler(function(error) {
                    hideLoading('userContributionMessage');
                    tableBody.innerHTML = `<tr><td colspan='6' class="message error-message">Error fetching contributions: ${error.message}</td></tr>`;
                    document.getElementById('userOverallTotal').textContent = 'Error';
                    setMessage('userContributionMessage', "Error fetching contributions: " + error.message, 'error');
                    console.error("Error fetching user contributions:", error);
                })
                .getContributionsForUser(currentUser.kingdomIds, period);
        }

        function displayUserContributions(data) {
            const tableBody = document.querySelector("#userContributionTable tbody");
            tableBody.innerHTML = "";
            let overallTotal = 0;

            if (data && data.length > 0) {
                const aggregatedData = {};
                // Aggregate contributions by Kingdom ID
                data.forEach(item => {
                    if (!aggregatedData[item.kingdomId]) {
                        aggregatedData[item.kingdomId] = {
                            from: item.from || '',
                            to: item.to || '',
                            kingdomId: item.kingdomId,
                            name: item.name || 'N/A',
                            continent: item.continent || 'N/A',
                            total: 0
                        };
                    }
                    aggregatedData[item.kingdomId].total += item.total;
                });

                // Convert aggregated object to an array for sorting and display
                const sortedAggregatedData = Object.values(aggregatedData).sort((a, b) => b.total - a.total);

                sortedAggregatedData.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = item.from;
                    row.insertCell(1).textContent = item.to;
                    row.insertCell(2).textContent = item.kingdomId;
                    row.insertCell(3).textContent = item.name;
                    row.insertCell(4).textContent = item.continent;
                    row.insertCell(5).textContent = item.total.toLocaleString(); // Format number
                    overallTotal += item.total;
                });

            } else {
                tableBody.innerHTML = "<tr><td colspan='6'>No Contributions Found for the selected period or kingdoms.</td></tr>";
            }
            document.getElementById('userOverallTotal').textContent = overallTotal.toLocaleString();
        }


        // Load user's current kingdoms for the manage section
        function loadUserKingdoms() {
            if (!currentUser || ADMIN_USERNAMES.map(name => name.toLowerCase()).includes(currentUser.username.toLowerCase())) {
                document.getElementById('userKingdomsTable').querySelector('tbody').innerHTML = '<tr><td colspan="2">Please log in as a regular user.</td></tr>';
                return;
            }
            const tableBody = document.querySelector("#userKingdomsTable tbody");
            tableBody.innerHTML = "<tr><td colspan='2'>Loading your kingdom IDs...</td></tr>";
            showLoading('manageKingdomsMessage', 'Loading your kingdom IDs...');

            // The currentUser object already has the latest kingdomIds after login/update
            const kingdomIds = currentUser.kingdomIds;
            hideLoading('manageKingdomsMessage');
            tableBody.innerHTML = ''; // Clear loading message

            if (kingdomIds && kingdomIds.length > 0) {
                kingdomIds.forEach(id => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = id;
                    const actionCell = row.insertCell(1);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.className = 'action-button delete-btn';
                    deleteButton.onclick = () => deleteKingdom(id);
                    actionCell.appendChild(deleteButton);
                });
            } else {
                tableBody.innerHTML = "<tr><td colspan='2'>No Kingdom IDs registered yet.</td></tr>";
            }
            document.getElementById('newKingdomId').value = ''; // Clear new kingdom input
            setMessage('manageKingdomsMessage', '', 'success'); // Clear any previous message
        }

        // Add a new kingdom ID to a user's account
        function addNewKingdom() {
            if (!currentUser) return;
            const newKid = document.getElementById('newKingdomId').value.trim();
            if (!newKid) {
                setMessage('manageKingdomsMessage', 'Please enter a Kingdom ID.', 'error');
                return;
            }

            showLoading('manageKingdomsMessage', 'Adding kingdom...'); // Show loading indicator
            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('manageKingdomsMessage'); // Hide loading
                    if (response.success) {
                        setMessage('manageKingdomsMessage', response.message, 'success');
                        // Update currentUser object with new kingdom ID if not already present (server-side check)
                        if (!currentUser.kingdomIds.includes(newKid)) {
                            currentUser.kingdomIds.push(newKid);
                        }
                        loadUserKingdoms(); // Reload the list
                    } else {
                        setMessage('manageKingdomsMessage', response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading('manageKingdomsMessage'); // Hide loading
                    setMessage('manageKingdomsMessage', "Error adding kingdom: " + error.message, 'error');
                })
                .addKingdomToUser(currentUser.username, newKid);
        }

        // Delete a kingdom ID from the user's account with confirmation
        async function deleteKingdom(kingdomId) {
            if (!currentUser) return;
            const confirmed = await showCustomModal("Confirm Deletion", `Are you sure you want to delete Kingdom ID: ${kingdomId}? This action cannot be undone.`, true);
            if (confirmed) {
                showLoading('manageKingdomsMessage', 'Deleting kingdom...'); // Show loading indicator
                google.script.run
                    .withSuccessHandler(function(response) {
                        hideLoading('manageKingdomsMessage'); // Hide loading
                        if (response.success) {
                            setMessage('manageKingdomsMessage', response.message, 'success');
                            // Update currentUser object by filtering out the deleted ID
                            currentUser.kingdomIds = currentUser.kingdomIds.filter(id => id !== kingdomId);
                            loadUserKingdoms(); // Reload the list
                        } else {
                            setMessage('manageKingdomsMessage', response.message, 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading('manageKingdomsMessage'); // Hide loading
                        setMessage('manageKingdomsMessage', "Error deleting kingdom: " + error.message, 'error');
                    })
                    .deleteKingdomFromUser(currentUser.username, kingdomId);
            }
        }


        function getAdminUsers() {
            const tableBody = document.querySelector("#adminUsersTable tbody");
            tableBody.innerHTML = "<tr><td colspan='3'>Loading users...</td></tr>";
            showLoading('adminContributionMessage', 'Fetching user list...'); // Re-use message div, or add new one if preferred

            google.script.run
                .withSuccessHandler(function(users) {
                    hideLoading('adminContributionMessage');
                    displayAdminUsers(users);
                })
                .withFailureHandler(function(error) {
                    hideLoading('adminContributionMessage');
                    tableBody.innerHTML = `<tr><td colspan='3' class="message error-message">Error fetching users: ${error.message}</td></tr>`;
                    setMessage('adminContributionMessage', "Error fetching users: " + error.message, 'error');
                    console.error("Error fetching admin users:", error);
                })
                .getAdminUsers();
        }

        function displayAdminUsers(users) {
             const tableBody = document.querySelector("#adminUsersTable tbody");
             tableBody.innerHTML = "";
             if (users && users.length > 0) {
                 users.forEach(user => {
                     const row = tableBody.insertRow();
                     row.insertCell(0).textContent = user.username;
                     row.insertCell(1).textContent = user.walletAddress;
                     row.insertCell(2).textContent = user.kingdomIds.join(', ');
                 });
             } else {
                 tableBody.innerHTML = "<tr><td colspan='3'>No registered users found.</td></tr>";
             }
             // Ensure search filter is applied if there's text
             filterTable('adminUsersTable', 'userSearch');
        }


        function getAdminContributions() {
            const period = document.getElementById('adminContributionPeriod').value;
            const tableBody = document.querySelector("#adminContributionTable tbody");
            tableBody.innerHTML = "<tr><td colspan='5'>Fetching all user contributions...</td></tr>";
            document.getElementById('adminOverallTotal').textContent = 'Calculating...';
            showLoading('adminContributionMessage', 'Fetching all contributions...');

            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('adminContributionMessage');
                    displayAdminContributions(response.data); // Data is already aggregated here
                })
                .withFailureHandler(function(error) {
                    hideLoading('adminContributionMessage');
                    tableBody.innerHTML = `<tr><td colspan='5' class="message error-message">Error fetching admin contributions: ${error.message}</td></tr>`;
                    document.getElementById('adminOverallTotal').textContent = 'Error';
                    setMessage('adminContributionMessage', "Error fetching admin contributions: " + error.message, 'error');
                    console.error("Error fetching admin contributions:", error);
                })
                .getAllUsersContributions(period);
        }

        function displayAdminContributions(data) { // Data is now pre-aggregated from the server
            const tableBody = document.querySelector("#adminContributionTable tbody");
            tableBody.innerHTML = "";
            let overallTotal = 0;

            if (data && data.length > 0) {
                // Data is already aggregated by username-kingdomId on the server
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = item.username;
                    row.insertCell(1).textContent = item.kingdomId;
                    row.insertCell(2).textContent = item.name;
                    row.insertCell(3).textContent = item.continent;
                    row.insertCell(4).textContent = item.total.toLocaleString(); // Format number
                    overallTotal += item.total;
                });
            } else {
                tableBody.innerHTML = "<tr><td colspan='5'>No Contributions Found for the selected period for all users.</td></tr>";
            }
            document.getElementById('adminOverallTotal').textContent = overallTotal.toLocaleString();
            // Ensure search filter is applied if there's text
            filterTable('adminContributionTable', 'contributionSearch');
        }

        function getTopContributorsData() {
            const period = document.getElementById('topContributorPeriod').value;
            const tableBody = document.querySelector("#topContributorsTable tbody");
            tableBody.innerHTML = "<tr><td colspan='3'>Loading top contributors...</td></tr>";
            document.getElementById('topContributorsOverallTotal').textContent = 'Calculating...';
            showLoading('topContributorsMessage', 'Fetching top contributors...');

            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('topContributorsMessage');
                    displayTopContributors(response.data, response.from, response.to, 'topContributorsTable', 'topContributorsOverallTotal');
                })
                .withFailureHandler(function(error) {
                    hideLoading('topContributorsMessage');
                    tableBody.innerHTML = `<tr><td colspan='3' class="message error-message">Error fetching top contributors: ${error.message}</td></tr>`;
                    document.getElementById('topContributorsOverallTotal').textContent = 'Error';
                    setMessage('topContributorsMessage', "Error fetching top contributors: " + error.message, 'error');
                    console.error("Error fetching top contributors:", error);
                })
                .getTopContributors(period);
        }

        function getUserTopContributorsData() { // New function for user's top contributors
            const period = document.getElementById('userTopContributorPeriod').value;
            const tableBody = document.querySelector("#userTopContributorsTable tbody");
            tableBody.innerHTML = "<tr><td colspan='3'>Loading top contributors...</td></tr>";
            document.getElementById('userTopContributorsOverallTotal').textContent = 'Calculating...';
            showLoading('userTopContributorsMessage', 'Fetching top contributors...');

            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoading('userTopContributorsMessage');
                    displayTopContributors(response.data, response.from, response.to, 'userTopContributorsTable', 'userTopContributorsOverallTotal');
                })
                .withFailureHandler(function(error) {
                    hideLoading('userTopContributorsMessage');
                    tableBody.innerHTML = `<tr><td colspan='3' class="message error-message">Error fetching top contributors: ${error.message}</td></tr>`;
                    document.getElementById('userTopContributorsOverallTotal').textContent = 'Error';
                    setMessage('userTopContributorsMessage', "Error fetching top contributors: " + error.message, 'error');
                    console.error("Error fetching user top contributors:", error);
                })
                .getTopContributors(period); // Re-using the same backend function
        }


        function displayTopContributors(data, fromDate, toDate, tableId, totalId) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = "";
            let periodTotal = 0;

            if (data && data.length > 0) {
                data.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = index + 1; // Rank
                    row.insertCell(1).textContent = item.username;
                    row.insertCell(2).textContent = item.totalContribution.toLocaleString();
                    periodTotal += item.totalContribution;
                });
            } else {
                tableBody.innerHTML = "<tr><td colspan='3'>No top contributors found for this period.</td></tr>";
            }
            document.getElementById(totalId).textContent = periodTotal.toLocaleString();
        }


        function exportUserContributionsToCSV() {
            const table = document.getElementById("userContributionTable");
            exportTableToCSV(table, "user_contributions.csv");
        }

        function exportAdminContributionsToCSV() {
            const table = document.getElementById("adminContributionTable");
            exportTableToCSV(table, "all_users_contributions.csv");
        }

        function exportTableToCSV(table, filename) {
            const csv = [];
            // Get table headers (from thead)
            const headerRow = table.querySelector("thead tr");
            if (headerRow) {
                const headers = Array.from(headerRow.querySelectorAll("th")).map(th => {
                    let text = th.innerText.replace(/ \u25B2| \u25BC/, ''); // Remove sort arrows
                    if (text.includes(',')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                });
                csv.push(headers.join(","));
            }

            // Get table body rows
            const rows = table.querySelectorAll("tbody tr");
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll("td"); // Only consider <td> for data
                if (cols.length > 0 && cols[0].colSpan !== table.rows[0].cells.length) { // Ensure it's not a loading/empty message row
                    for (let j = 0; j < cols.length; j++) {
                        let text = cols[j].innerText;
                        // Handle commas within cells by enclosing in double quotes
                        if (text.includes(',')) {
                            text = `"${text.replace(/"/g, '""')}"`; // Escape double quotes
                        }
                        row.push(text);
                    }
                    csv.push(row.join(","));
                }
            }

            const csvFile = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // --- NEW FEATURES ---

        // Generic Table Sorting Function
        let sortDirections = {}; // Store sort direction for each table/column

        function sortTable(tableId, n) {
            const table = document.getElementById(tableId);
            let rows = Array.from(table.rows).slice(1); // Exclude header row
            const isTotalRowPresent = table.querySelector('.total-row');
            if (isTotalRowPresent) {
                rows = rows.slice(0, -1); // Exclude total row if present
            }

            const header = table.querySelector('th:nth-child(' + (n + 1) + ')');

            let direction = sortDirections[tableId + '_' + n] || 'asc';
            const isNumeric = header.textContent.includes('Points') || header.textContent.includes('Rank') || header.textContent.includes('Total Contribution');

            rows.sort((rowA, rowB) => {
                let x = rowA.cells[n].innerText;
                let y = rowB.cells[n].innerText;

                if (isNumeric) {
                    x = parseFloat(x.replace(/,/g, '')) || 0; // Handle thousands separators
                    y = parseFloat(y.replace(/,/g, '')) || 0;
                } else {
                    x = x.toLowerCase();
                    y = y.toLowerCase();
                }

                if (direction === 'asc') {
                    return x > y ? 1 : -1;
                } else {
                    return x < y ? 1 : -1;
                }
            });

            // Toggle sort direction for next click
            sortDirections[tableId + '_' + n] = (direction === 'asc') ? 'desc' : 'asc';

            // Update header classes for arrows
            Array.from(table.querySelectorAll('th')).forEach((th, index) => {
                th.classList.remove('asc', 'desc');
                if (index === n) {
                    th.classList.add(direction); // Apply the direction used for sorting *this* time
                }
            });

            const tbody = table.querySelector('tbody');
            tbody.innerHTML = ''; // Clear current rows
            rows.forEach(row => tbody.appendChild(row)); // Append sorted rows

            if (isTotalRowPresent) {
                tbody.appendChild(isTotalRowPresent); // Re-append total row at the end
            }
        }

        // Generic Table Filter Function
        function filterTable(tableId, inputId) {
            const input = document.getElementById(inputId);
            const filter = input.value.toUpperCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) { // Skip header row
                let rowText = "";
                const cells = tr[i].getElementsByTagName("td");
                // Concatenate text from relevant cells for filtering
                for (let j = 0; j < cells.length; j++) {
                    rowText += cells[j].textContent + " ";
                }
                if (rowText.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    </script>
</body>
</html>
